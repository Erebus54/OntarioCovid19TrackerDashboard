---
title: "Ontario COVID19 Dashboard"
author: Patrick Reza Schnurbusch 
date: '`r paste("Last Update: ", format(Sys.time(), "%Y-%m-%d"))`'
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    social: menu
    theme: paper
    source_code: embed
runtime: shiny
---

```{r setup, include=FALSE}
setwd("C:/Users/patri/Documents/covid19/ON_Dashboard/")
library(rsconnect)

#viz libs 
library(flexdashboard)
library(plotly)
library(RColorBrewer)

#data manipulation
library(lubridate)
library(tidyverse)
library(data.table)

#global province wide stats 
ConfirmedPositives <- read.csv("./datasets/confirmedpositives.csv", fileEncoding = "UTF-8")
#ConfirmedPositives <- data.frame(ConfirmedPositives)
ConfirmedPositives$Reported.Date <- as.Date(ConfirmedPositives$Reported.Date, format = "%Y-%m-%d")

#individual PHU level case status recrod 
casestatus <- read.csv("./datasets/casestatus.csv", fileEncoding = "UTF-8")
#casestatus <- data.frame(casestatus)
casestatus$Accurate_Episode_Date <- as.Date(casestatus$Accurate_Episode_Date, format = "%Y-%m-%d")
casestatus$Case_Reported_Date <- as.Date(casestatus$Case_Reported_Date, format = "%Y-%m-%d")
casestatus$Test_Reported_Date <- as.Date(casestatus$Test_Reported_Date, format = "%Y-%m-%d")
```

```{r}
df <- casestatus %>% 
  dplyr::group_by(Accurate_Episode_Date, Reporting_PHU, Reporting_PHU_Latitude, Reporting_PHU_Longitude) %>% 
  dplyr::count(name = "ConfirmedPositives")

#Date cleaning 
#filter out NA dates 
df <- df %>% dplyr::filter(!Accurate_Episode_Date == is.na(Accurate_Episode_Date)) %>% 
  #cleaning out dates before year:2020, some row has 2019 and 1992 which cannot be accurate 
  dplyr::filter(!Accurate_Episode_Date < "2020-01-01")

#creating a csum per PHU
df <- df %>% dplyr::group_by(Reporting_PHU) %>% 
  dplyr::mutate(PHU_csum = cumsum(ConfirmedPositives))


#adding the relative change per day in cases 
df <- df %>% 
  dplyr::group_by(Reporting_PHU) %>% 
  dplyr::mutate(Accurate_Episode_Date = as.Date(Accurate_Episode_Date), 
                #finding the difference between the current date and the last date in days 
                diff_days = as.numeric(Accurate_Episode_Date - lag(Accurate_Episode_Date)), 
                New_cases_pct = round((ConfirmedPositives/diff_days) / PHU_csum * 100, 1)
  )

#creating a global ONTARIO cumSUM 
df <- df %>% dplyr::group_by(Accurate_Episode_Date) %>% 
  dplyr::mutate(csumON = cumsum(ConfirmedPositives)) 

#regionalizations
#src https://cdn.ymaws.com/alphaweb.site-ym.com/resource/resmgr/alpha_region_map_250320.jpg
df$Region <- as.character("")
#sort(unique(df$Reporting_PHU))
df$Region <- ifelse(df$Reporting_PHU %in% c("Northwestern Health Unit","Thunder Bay District Health Unit"), "North West", df$Region)
df$Region <- ifelse(df$Reporting_PHU %in% c("Porcupine Health Unit", "Algoma Public Health Unit",
                                            "Sudbury & District Health Unit", "Timiskaming Health Unit",
                                            "North Bay Parry Sound District Health Unit"), 
                    yes = "North East", 
                    no = df$Region)


df$Region <- ifelse(df$Reporting_PHU == "Toronto Public Health", "Toronto", df$Region)
df$Region <- ifelse(df$Reporting_PHU %in% c("Renfrew County and District Health Unit",
                                            "Ottawa Public Health", 
                                            "Eastern Ontario Health Unit",
                                            "Hastings and Prince Edward Counties Health Unit", 
                                            "Kingston, Frontenac and Lennox & Addington Public Health",
                                            "Leeds, Grenville and Lanark District Health Unit"), "East", df$Region)

df$Region <- ifelse(df$Reporting_PHU %in% c("Simcoe Muskoka District Health Unit", 
                                            "Haliburton, Kawartha, Pine Ridge District Health Unit",
                                            "Peterborough Public Health",
                                            "Durham Region Health Department",
                                            "York Region Public Health Services",
                                            "Peel Public Health"), "Central East", df$Region)

df$Region <- ifelse(df$Reporting_PHU %in% c("Wellington-Dufferin-Guelph Public Health",
                                            "Halton Region Health Department",
                                            "Region of Waterloo, Public Health",
                                            "Hamilton Public Health Services",
                                            "Brant County Health Unit",
                                            "Niagara Region Public Health Department",
                                            "Haldimand-Norfolk Health Unit"), "Central West", df$Region)

df$Region <- ifelse(df$Reporting_PHU %in% c("Grey Bruce Health Unit", 
                                            "Huron Perth District Health Unit",
                                            "Lambton Public Health", "Middlesex-London Health Unit", 
                                            "Southwestern Public Health", 
                                            "Chatham-Kent Health Unit", 
                                            "Windsor-Essex County Health Unit"), "South West", df$Region)



#adding a region csum var 
df <- data.frame(df %>% 
                   dplyr::group_by(Accurate_Episode_Date, Region) %>% 
                   dplyr::mutate(Region_csum = cumsum(PHU_csum))
)


#creation a regionalized 
regions <- data.frame(df %>%
                        dplyr::select(Accurate_Episode_Date, Region, ConfirmedPositives) %>% 
                        dplyr::group_by(Accurate_Episode_Date, Region) %>% 
                        dplyr::mutate(ConfirmedPositives = sum(ConfirmedPositives)) %>% 
                        dplyr::distinct()
)


#adding difference in days 
regions <- data.frame(regions %>% 
                        dplyr::group_by(Region) %>% 
                        dplyr::mutate(Region_csum  = cumsum(ConfirmedPositives),
                                      Accurate_Episode_Date = as.Date(Accurate_Episode_Date),
                                      diff_days = as.numeric(Accurate_Episode_Date - lag(Accurate_Episode_Date)),
                                      New_cases_pct = round((ConfirmedPositives/diff_days) / Region_csum * 100, 1), 
                                      dt = round((1/log(2)) / log(1 + New_cases_pct), 1)
                        )
)
```


Case Status
=====================================
Row {.tabset .tabset-fade}
-------------------------------------

### <b> Linear Scale </b>

```{r}
fig <- plot_ly(x = ~ConfirmedPositives$Reported.Date, y = ~ConfirmedPositives$Total.Cases, type = 'scatter', mode = 'none', name = 'Total Cases', fill = 'tozeroy',fillcolor = '#FFC56C')

fig <- fig %>% add_trace(x = ~ConfirmedPositives$Reported.Date, y = ~ConfirmedPositives$Resolved, name = 'Resolved', fill = 'tozeroy',
                         fillcolor = '#6EC5E9')

fig <- fig %>% add_trace(x = ~ConfirmedPositives$Reported.Date, y = ~ConfirmedPositives$Deaths, name = 'Deaths', fill = 'tozeroy',
                         fillcolor = '#FF5959')

fig <- fig %>% layout(title = "<b> Daily Cases by Status </b>", 
                      xaxis = list(title = ''),
                      yaxis = list(title = 'Cumulative Case Counts'), 
                      hovermode = "x unified")
fig <- fig %>% 
  layout(xaxis = list(rangeselector = list(
    buttons = list(
      
      list(
        count = 1,
        label = "1 mo",
        step = "month",
        stepmode = "backward"),
      
      list(
        count = 3,
        label = "3 mo",
        step = "month",
        stepmode = "backward"),
      
      list(
        count = 6,
        label = "6 mo",
        step = "month",
        stepmode = "backward"),
      
      list(
        count = 1,
        label = "1 yr",
        step = "year",
        stepmode = "backward"),
      
      list(
        count = 1,
        label = "YTD",
        step = "year",
        stepmode = "todate"),
      list(step = "all")))
    #,rangeslider = list(type = "date")
    ))
fig
```

### <b> Logarithmic Scale </b>

```{r}
fig <- fig %>% layout(yaxis = list(type = "log"))
fig <- fig %>% layout(title = "Daily Cases by Status",
                      xaxis = list(title = "Daily Cases by Status (Log)"),
                      yaxis = list (title = "Cumulative Case Counts (Log)"))
fig
```

Row {.tabset .tabset-fade}
-------------------------------------
### <b> Doubling Times </b> 

```{r}

dt <- ConfirmedPositives %>% 
  dplyr::select(Reported.Date, Total.Cases) %>% 
  dplyr::arrange(Reported.Date) %>% 
  dplyr::mutate(d_diff = as.numeric(Reported.Date - lag(Reported.Date)), 
                diff_growth = Total.Cases - lag(Total.Cases), 
                gRate_pct = round((diff_growth/d_diff)/Total.Cases * 100, 2)
  )


dt$dt <- as.integer((difftime(dt$Reported.Date, min(dt$Reported.Date), units = "days")*log(2))/(log(dt$Total.Cases/1))) 

plot_ly(dt, 
        x = ~Reported.Date, 
        y = ~dt, 
        name = "dt",
        type = 'scatter', 
        fill ='tozeroy', 
        mode = 'lines', 
        line = list(width = 0.1)) %>% 
  
  layout(title = "Doubling Times",
         xaxis = list(title = ""), 
         yaxis = list(title = "Doubling Time (Days)"), 
         hovermode = "x unified")

```

### <b> Rolling Averages </b>

```{r}
rolling.avg <- ConfirmedPositives %>% 
  dplyr::select(Reported.Date, Confirmed.Positive) %>% 
  dplyr::mutate(cp.7 = round(zoo::rollmean(Confirmed.Positive, k = 7, fill = NA),0),
                cp.14 = round(zoo::rollmean(Confirmed.Positive, k = 14, fill = NA),0), 
                cp.28 = round(zoo::rollmean(Confirmed.Positive, k = 28, fill = NA),0), 
                cp.56 = round(zoo::rollmean(Confirmed.Positive, k = 56, fill = NA),0)
)


plot_ly(rolling.avg, x = ~Reported.Date, y = ~cp.7, name = "7 Day Average",
        type = 'scatter', mode = 'lines', fill = 'tozeroy', line = list(width = 0.1)) %>% 
  
  add_trace(y = ~cp.14, name = "14 Day Average") %>% 
  add_trace(y = ~cp.28, name = "28 Day Average ") %>% 
  add_trace(y = ~cp.56, name = "56 Day Average") %>% 
  
  layout(title = "<b> Moving Averages </b>",
         xaxis = list(title = "Date"), 
         yaxis = list(title = "New Cases"), 
         hovermode = "x unified")
```

### <b> New Cases (n) </b>
```{r}
case.percentages <- ConfirmedPositives %>% 
  dplyr::select(Reported.Date, Total.Cases, Resolved, Deaths)

case.percentages <- case.percentages %>%
  mutate(New_Total.Cases = Total.Cases - lag(Total.Cases,1, default = 0.0), 
         Total.Cases.Change.Pct = round(New_Total.Cases/Total.Cases*100 ,2), 
         
         New_Resolved = Resolved - lag(Resolved,1, default = 0.0), 
         Resolved.Change.Pct = round(New_Resolved/Resolved*100 ,2), 
         
         New_Deaths = Deaths - lag(Deaths,1, default = 0.0), 
         Deaths.Change.Pct = round(New_Deaths/Deaths*100 ,2))

fig <- plot_ly(case.percentages, x = ~case.percentages$Reported.Date, y = ~case.percentages$New_Total.Cases, type = 'bar', 
               name = 'New Total Cases', 
               marker = list(color = '#FFC56C'))
fig <- fig %>% add_trace(y = ~case.percentages$New_Resolved, 
                         name = 'New Resolved',
                         marker = list(color = '#6EC5E9'))
fig <- fig %>% add_trace(x = ~case.percentages$Reported.Date, y = ~case.percentages$New_Deaths, 
                         name = 'New Deaths', 
                         marker = list(color = '#FF5959'))
fig <- fig %>% layout(title = "", 
                      xaxis = list(title = ''),
                      yaxis = list(title = 'Absolute Change (n)'), 
                      barmode = 'stack',
                      hovermode = "x unified")
fig
```

### <b> New Cases (%) </b> 
```{r}
fig <- plot_ly(case.percentages, x = ~Reported.Date, y = ~Total.Cases.Change.Pct, type = 'bar', 
               name = 'New Total Cases', 
               marker = list(color = '#FFC56C'))
fig <- fig %>% add_trace(y = ~Resolved.Change.Pct, 
                         name = 'New Resolved', 
                         marker = list(color = '#6EC5E9'))
fig <- fig %>% add_trace(y = ~Deaths.Change.Pct, 
                         name = 'New Deaths', 
                         marker = list(color = '#FF5959'))
fig <- fig %>% layout(title = "", 
                      xaxis = list(title = ''),
                      yaxis = list(title = 'Relative Change (%)'), 
                      barmode = 'stack', 
                      hovermode = "x unified")
fig

```


Testing
===================================== 
Row {.tabset .tabset-fade}
-------------------------------------
### <b> Positives </b> 
```{r}
fig <- plot_ly(x = ConfirmedPositives$Reported.Date, 
               y = ConfirmedPositives$Confirmed.Positive, 
               type = 'scatter', mode = 'lines', name = 'Confirmed Positive', 
               fill = 'tozeroy',
        fillcolor = '#2858a6',
        line = list(width = 0.5))

fig <- fig %>% layout(title = "",
                      yaxis = list(title = 'Tested Positive'),
                      xaxis = list(title = 'Reported Date'),
                      hovermode = "x unified") %>% 
  
  layout(paper_bgcolor='transparent')
fig
```

### <b> Positives vs Total Tested </b> 
```{r}
fig <- plot_ly(ConfirmedPositives, x = ~Reported.Date, y = ~Confirmed.Positive, type = 'bar', name = 'Confirmed Positives', marker = list(color = 'FF5959'))
fig <- fig %>% add_trace(y = ~Total.tests.completed.in.the.last.day, name = 'Total Tested', marker = list(color = '6EC5E9'))
fig <- fig %>% layout(title = "", 
                      xaxis = list(title = 'Date'), 
                      yaxis = list(title = 'Counts'), barmode = 'stack', 
                      hovermode = "x unified")
fig
```

### <b> Test Positivity Rate </b> 
```{r}
test.positive.rate <- ConfirmedPositives %>% 
  dplyr::select(Reported.Date, Confirmed.Positive, Total.tests.completed.in.the.last.day) %>% 
  dplyr::mutate(Test.positive.rate = round(Confirmed.Positive/Total.tests.completed.in.the.last.day*100,2)) %>% 
  dplyr::select(Reported.Date, Test.positive.rate) 

test.positive.rate <- test.positive.rate[complete.cases(test.positive.rate), ]

fig <- plot_ly(test.positive.rate, x = ~Reported.Date, y = ~Test.positive.rate, type = 'bar', name = 'Test Positive Rate', 
               marker = list(color = '#FF9900'))
fig <- fig %>% layout(title = "", 
                      xaxis = list(title = 'Date'), 
                      yaxis = list(title = 'Tested Positive (%)'),
                      hovermode = "x unified")
fig
```


Hospitalizations
===================================== 
Row {.tabset .tabset-fade}
-------------------------------------

```{r}
#hospitalizations 
hospitalizations <- ConfirmedPositives %>% 
  dplyr::select(Reported.Date, 
                Number.of.patients.hospitalized.with.COVID.19, 
                Number.of.patients.in.ICU.with.COVID.19, 
                Number.of.patients.in.ICU.on.a.ventilator.with.COVID.19) %>% 
  
  dplyr::mutate(
    #absolute changes 
                New_hospitalized = Number.of.patients.hospitalized.with.COVID.19 - lag(Number.of.patients.hospitalized.with.COVID.19,1, default = 0.0),
                New_ICU = Number.of.patients.in.ICU.with.COVID.19 - lag(Number.of.patients.in.ICU.with.COVID.19,1, default = 0.0), 
                New_ventilator = Number.of.patients.in.ICU.on.a.ventilator.with.COVID.19 - lag(Number.of.patients.in.ICU.on.a.ventilator.with.COVID.19,1, default = 0.0),
                
                #relative changes 
                
                New_hospitalized.pct = round(New_hospitalized/Number.of.patients.hospitalized.with.COVID.19*100 ,2), 
                New_ICU.pct = round(New_ICU/Number.of.patients.in.ICU.with.COVID.19*100 ,2), 
                New_ventilator.pct = round(New_ventilator/Number.of.patients.in.ICU.on.a.ventilator.with.COVID.19*100 ,2))
```

### <b> Hospitalizations </b>
```{r}
fig <- plot_ly(hospitalizations, x = ~Reported.Date, y = ~Number.of.patients.hospitalized.with.COVID.19, 
               type = 'scatter', 
               mode = 'markers',
               name = 'Patients Hospitalized', 
               marker = list(color = '#2C82C9', size = 5))
fig <- fig %>% add_trace(y = ~Number.of.patients.in.ICU.with.COVID.19, name = 'Intensive Care Patients', 
                         marker = list(color = '#FCB941', size = 5))
fig <- fig %>% add_trace(y = ~Number.of.patients.in.ICU.on.a.ventilator.with.COVID.19, name = 'ICU Ventilator Patients', 
                         marker = list(color = '#FC6042', size = 5))
fig <- fig %>% layout(title = "",
                      xaxis = list(title = ''), 
                      yaxis = list(title = 'Number of Patients'), barmode = 'stack', 
                      hovermode = "x unified")
fig
```

### <b> Change in Hospitalizations (Absolute) </b>

```{r}
fig <- plot_ly(data = hospitalizations, x = ~Reported.Date,y = ~New_hospitalized, 
               type = 'scatter',
               mode = 'lines+markers', 
               name = "Patients Hospitalized", 
               marker = list(color = '#2C82C9'),
               line = list(color = '#2C82C9', width = 1)
) 
fig <- fig %>% add_trace(y = ~New_ICU, name = "Intensive Care Patients", mode = 'lines+markers',
                         marker = list(color = '#FCB941'),
                         line = list(color = '#FCB941', width = 1)
)
fig <- fig %>% add_trace(y = ~New_ventilator, name = "ICU Ventilator Patients", mode = 'lines+markers',
                         marker = list(color = '#FC6042'),
                         line = list(color = '#FC6042', width = 1)
)
fig <- fig %>% layout(title = "",
                      xaxis = list(title = ''), 
                      yaxis = list(title = 'Change in Patients (n)'), barmode = 'stack', 
                      hovermode = "x unified")
fig
```

### <b> Change in Hospitalizations (Relative) </b> 

```{r}
fig <- plot_ly(data = hospitalizations, x = ~Reported.Date,y = ~New_hospitalized.pct, 
               type = 'scatter',
               mode = 'lines+markers', 
               name = "Patients Hospitalized", 
               marker = list(color = '#2C82C9'), 
               line = list(color = '#2C82C9', width = 1)
               ) 
fig <- fig %>% add_trace(y = ~New_ICU.pct, name = "Intensive Care Patients", mode = 'lines+markers',
                         marker = list(color = '#FCB941'),
                         line = list(color = '#FCB941', width = 1)
                         )
fig <- fig %>% add_trace(y = ~New_ventilator.pct, name = "ICU Ventilator Patients", mode = 'lines+markers',
                         marker = list(color = '#FC6042'),
                         line = list(color = '#FC6042', width = 1)
                         )
fig <- fig %>% layout(title = "",
                      xaxis = list(title = ''),  
                      yaxis = list(title = 'Change in Patients (%)'), barmode = 'stack', 
                      hovermode = "x unified")
fig
```


About this Site
===================================== 

#### Last Update  

04 September 2020 

#### Background
*"Nothing in life is to be feared, it is only to be understood. Now is the time to understand more, so that we may fear less" - Marie Curie*  


#### Code
Code and input data used to generate this Shiny mapping tool are available on [Github](https://github.com/Erebus54/OntarioCovid19TrackerDashboard/tree/master/ON_Dashboard).

#### Sources 

**Confirmed positive cases of COVID-19 in Ontario**: [Open Data Ontaro](https://data.ontario.ca/en/dataset/confirmed-positive-cases-of-covid-19-in-ontario), updated daily, statistics on  testing, hospitalizations, and long term care facilities 

**Status of COVID-19 cases in Ontario** : [Open Data Ontario](https://data.ontario.ca/dataset/status-of-covid-19-cases-in-ontario), updated daily, which presents a breakdown by region, case status, age range of cases 


#### Author 
Patrick Schnurbusch 